{"pageProps":{"postData":{"id":"How-to-monitor-hardware-variable-in-php","contentHtml":"<p>In my previous job, we released the MoonGuard Filament Plugin, a PHP package\nfor monitoring Laravel applications in the cloud. We had been searching for\nnew features to enhance the experience of supporting and monitoring these\napplications. One of the challenges we encountered was the ability to monitor\nserver hardware variables, such as CPU and RAM usage, as well as disk storage\nspace. These variables provide crucial information about our servers, allowing\nus to optimize our applications and prevent critical failures. Therefore, we\nconducted research on how to monitor these variables using PHP.</p>\n<h2 id=\"cpu-load\">Cpu Load</h2>\n<p>In PHP, there is a function called <code>sys_getloadavg()</code> which is used to obtain\nthe average system load. It returns three samples that represent the average\nsystem load over the last 1, 5, and 15 minutes, respectively. This function is\nuseful for monitoring system performance. It is important to note that this\nfunction only works on Unix systems such as Linux and MacOS. Therefore, it is\nnot available on Windows platforms. You can refer to the official PHP\n<a href=\"https://www.php.net/manual/es/function.sys-getloadavg.php\">documentation</a> for\nmore information on how to use this function.</p>\n<p>With this function, we can create a method that retrieves the three data values\nin percentage and stores them in an array to use them.</p>\n<pre class=\"language-php\"><code class=\"language-php code-highlight\"><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getCpuLoadUsage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">float</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'sys_getloadavg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">      <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">sys_getloadavg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token punctuation\">}</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fn</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$n</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$n</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token keyword\">return</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">      <span class=\"token comment\">//handle exception</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token punctuation\">}</span>\n</span></span></code></pre>\n<h2 id=\"memory\">Memory</h2>\n<p>To obtain the percentage of used memory, we found a method in the\n<a href=\"https://github.com/MohsenAbrishami/stethoscope\">stethoscope</a> package that\nmakes use of Unix system commands, such as the <code>free</code> command, which displays\nthe amount of free and used memory in the system.</p>\n<p>To use this command in PHP, we can use the\n<a href=\"https://www.php.net/manual/es/function.shell-exec.php\"><code>shell_exec</code></a>\nfunction, which allows us to execute commands in the terminal and save their\noutput in a PHP variable. This way, we can create a method that executes the\n'free' command and use the <code>grep Mem</code> command to filter the output and display\nonly the line that contains the word 'Mem', which has the amount of RAM memory\nin the system.</p>\n<p>To obtain the percentage, we will use <code>awk’{print$3/$2 * 100}’</code>, this will give\nus the field that contains the amount of used RAM, we divide it by the total\namount of RAM and by multiplying by 100 we will get the percentage value.</p>\n<pre class=\"language-php\"><code class=\"language-php code-highlight\"><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getMemoryUsage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">float</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'exec'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">      <span class=\"token variable\">$memory</span> <span class=\"token operator\">=</span> <span class=\"token function\">shell_exec</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\" free | grep Mem | awk '{print <span class=\"token interpolation\"><span class=\"token variable\">$3</span></span>/<span class=\"token interpolation\"><span class=\"token variable\">$2</span></span> * 100}' \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">      <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-casting\">float</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$memory</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token punctuation\">}</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token keyword\">return</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token comment\">//handle exception</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token punctuation\">}</span>\n</span></span></code></pre>\n<h2 id=\"space-disk\">Space Disk</h2>\n<p>To obtain the disk space, we can use the PHP <code>functions disk_free_space</code> and\n<code>disk_total_space</code>, which allow us to get the available and total space of the\ndirectory passed to your Linux server as a parameter. This way, we can create a\nmethod that indicates both the total space of the disk and the available space\nin the following way.</p>\n<pre class=\"language-php\"><code class=\"language-php code-highlight\"><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getDiskUsage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">array</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token variable\">$freeSpace</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token variable\">$totalSpace</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'disk_free_space'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'disk_total_space'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">      <span class=\"token variable\">$freeSpace</span> <span class=\"token operator\">=</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">disk_free_space</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">pow</span><span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">      <span class=\"token variable\">$totalSpace</span> <span class=\"token operator\">=</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">disk_total_space</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">pow</span><span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token punctuation\">}</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">      <span class=\"token string single-quoted-string\">'freeSpace'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$freeSpace</span><span class=\"token punctuation\">,</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">      <span class=\"token string single-quoted-string\">'totalSpace'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$totalSpace</span><span class=\"token punctuation\">,</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token keyword\">return</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">    <span class=\"token comment\">//handle exception</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\">  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"code-line\"><span class=\"token php language-php\"><span class=\"token punctuation\">}</span>\n</span></span></code></pre>\n<p>We use the function <code>pow(1024, 3)</code> to obtain the value in gigabytes, which makes\nit more efficient.</p>\n<p>Having these methods, you can use them in your Laravel or PHP project. I hope\nthey are useful to you.</p>","title":"How to monitor hardware variables in PHP","date":"2023-05-08","description":"How to monitor hardware variables like cpu load, memory usage, disk usage and disk total with PHP.","keywords":"PHP, hardware, Laravel","category":"Software Engineering"}},"__N_SSG":true}